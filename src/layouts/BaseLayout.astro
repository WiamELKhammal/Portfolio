---
// src/layouts/BaseLayout.astro
// Global layout component for the entire site - Optimized for PageSpeed

import SEO from "../components/common/SEO.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

// Import consolidated global styles
import "../styles/global.css";

// Define props for metadata
export interface Props {
  title?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
}

const {
  title = "Portfolio — Wiam EL Khammal",
  description = "Software Engineer Portfolio — minimal, aesthetic one-page showcasing skills, experience, education, and projects.",
  canonical = "https://kchndz.dev",
  ogImage = "https://kchndz.dev/img/og-image.jpg",
}: Props = Astro.props;

// Get current year for copyright
const currentYear = new Date().getFullYear();
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="color-scheme" content="dark light" />
    <meta name="author" content="Wiam EL Khammal" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO Component - Meta tags, Open Graph, Twitter Cards, Structured Data -->
    <SEO
      title={title}
      description={description}
      canonical={canonical}
      ogImage={ogImage}
    />

    <!-- Preconnect for performance - with dns-prefetch fallback -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.gstatic.com" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />

    <!-- Preload critical font weights (Inter 400, 600, 700) -->
    <link
      rel="preload"
      href="https://fonts.gstatic.com/s/inter/v18/UcCO3FwrK3iLTeHuS_nVMrMxCp50SjIw2boKoduKmMEVuLyfAZ9hjp-Ek-_EeA.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <!-- Fonts - Inter with display=swap for better LCP -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet"
      />
    </noscript>

    <!-- Icons - Font Awesome (defer loading for better FCP) -->
    <link
      rel="preload"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      as="style"
      onload="this.onload=null;this.rel='stylesheet'"
    />
    <noscript>
      <link
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        rel="stylesheet"
      />
    </noscript>

    <!-- Favicons -->
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon.ico" />

    <!-- Critical CSS for above-the-fold content (inlined) -->
    <style is:inline>
      /* Critical CSS - Prevents Flash of Unstyled Content */
      :root {
        --bg: #0b0c0e;
        --text: #e8e9ea;
        --muted: #9aa0a7;
        --border: #1e2329;
        --font-sans: "Inter", system-ui, -apple-system, sans-serif;
      }
      [data-theme="light"] {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --border: #e5e7eb;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: var(--font-sans);
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
      }
      /* Prevent layout shift from scrollbar */
      html,
      body {
        overflow-x: hidden;
        max-width: 100vw;
      }
    </style>
  </head>

  <body data-theme="dark">
    <!-- Skip to main content link for accessibility -->
    <a href="#main-content" class="sr-only">Skip to main content</a>

    <!-- Site Header -->
    <Header />

    <!-- Main Content -->
    <main id="main-content">
      <slot />
    </main>

    <!-- Site Footer -->
    <Footer />

    <!-- Back to top button -->
    <button class="to-top" aria-label="Back to top" type="button">
      <i class="fa-solid fa-arrow-up" aria-hidden="true"></i>
    </button>

    <!-- Theme initialization (runs before paint to prevent flash) -->
    <script is:inline>
      // Initialize theme from localStorage or system preference
      (function () {
        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;
        const theme = savedTheme || (prefersDark ? "dark" : "light");
        document.body.setAttribute("data-theme", theme);
      })();
    </script>

    <!-- Main scripts - deferred for better performance -->
    <script>
      // Theme toggle functionality
      function initThemeToggle() {
        const themeToggle = document.getElementById("theme-toggle");

        if (themeToggle) {
          themeToggle.addEventListener("click", () => {
            const currentTheme = document.body.getAttribute("data-theme");
            const newTheme = currentTheme === "dark" ? "light" : "dark";

            document.body.setAttribute("data-theme", newTheme);
            localStorage.setItem("theme", newTheme);

            // Update toggle icon
            const icon = themeToggle.querySelector("i");
            if (icon) {
              icon.className =
                newTheme === "dark" ? "fas fa-moon" : "fas fa-sun";
            }
          });

          // Set initial icon based on current theme
          const currentTheme = document.body.getAttribute("data-theme");
          const icon = themeToggle.querySelector("i");
          if (icon) {
            icon.className =
              currentTheme === "dark" ? "fas fa-moon" : "fas fa-sun";
          }
        }
      }

      // Back to top button functionality
      function initBackToTop() {
        const toTopBtn = document.querySelector(".to-top");

        if (toTopBtn) {
          // Show/hide button based on scroll position
          const handleScroll = () => {
            if (window.scrollY > 300) {
              toTopBtn.classList.add("show");
            } else {
              toTopBtn.classList.remove("show");
            }
          };

          // Use requestAnimationFrame for better performance
          let ticking = false;
          window.addEventListener(
            "scroll",
            () => {
              if (!ticking) {
                requestAnimationFrame(() => {
                  handleScroll();
                  ticking = false;
                });
                ticking = true;
              }
            },
            { passive: true },
          );

          // Scroll to top when clicked
          toTopBtn.addEventListener("click", () => {
            window.scrollTo({
              top: 0,
              behavior: "smooth",
            });
          });

          // Initial check
          handleScroll();
        }
      }

      // Reveal animations on scroll - using Intersection Observer
      function initRevealAnimations() {
        const reveals = document.querySelectorAll(".reveal:not(.in)");

        if (reveals.length === 0) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("in");
                observer.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.1,
            rootMargin: "0px 0px -50px 0px",
          },
        );

        reveals.forEach((el) => observer.observe(el));
      }

      // Initialize all functionality
      function init() {
        initThemeToggle();
        initBackToTop();
        initRevealAnimations();
      }

      // Run on DOM ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }

      // Also run on Astro page transitions (View Transitions API)
      document.addEventListener("astro:page-load", init);
    </script>
  </body>
</html>
