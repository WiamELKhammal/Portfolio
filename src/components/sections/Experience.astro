---
// src/components/sections/Experience.astro
import Section from "../common/Section.astro";
import Card from "../common/Card.astro";
import Badge from "../common/Badge.astro";
import { experienceData } from "../../data/experience";
import { getSkillLogo } from "../../data/skills"; // Import this helper
import type { ExperienceEntry } from "../../types";

export interface Props {
  experiences?: ExperienceEntry[];
  initialCount?: number;
  class?: string;
}

const {
  experiences = experienceData,
  initialCount = 3,
  class: className = "",
} = Astro.props;

const visibleExperiences = experiences.slice(0, initialCount);
const hiddenExperiences = experiences.slice(initialCount);
const hasMoreExperiences = hiddenExperiences.length > 0;
---

<Section id="experience" title="Professional Experience" class={className}>
  <div class="experience-container">
    <div class="experience-list">
      {
        visibleExperiences.map((job) => (
          <Card hoverable class="experience-card">
            <header class="card-head">
              <div class="meta-left">
                <div class="title-meta">
                  <h3>{job.title}</h3>
                  <div class="meta-line">
                    <i
                      class="fa-sharp fa-solid fa-location-dot"
                      aria-hidden="true"
                    />
                    <span>{job.location}</span>
                  </div>
                </div>
              </div>

              <div class="meta-right">
                <div class="org-badge">
                  <span>{job.company}</span>
                </div>
                <div class="meta-date">
                  {job.startDate} â€” {job.endDate}
                </div>
              </div>
            </header>

            <ul class="card-list">
              {job.description.map((item) => (
                <li>{item}</li>
              ))}
            </ul>

            {job.skills.length > 0 && (
              <div class="kw-list">
                {job.skills.map((skill) => (
                  <Badge variant="default" size="sm" hoverable>
                    {skill}
                  </Badge>
                ))}
              </div>
            )}
          </Card>
        ))
      }
    </div>
  </div>
</Section>

<style>
  /* --- Layout --- */
  .experience-list {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  /* --- Header Layout --- */
  .card-head {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    margin-bottom: 0.5rem; /* Matched to Education */
  }

  /* --- Title (Job Title) --- */
  .title-meta h3 {
    font-size: clamp(1.05rem, 1rem + 0.4vw, 1.2rem); /* Matched to Education clamp */
    line-height: 1.2;
    margin: 0 0 0.2rem;
    color: var(--text);
  }

  .meta-left {
    display: flex;
    flex-direction: column;
    gap: 0.25rem; /* Matched space between Title and Location */
    flex: 1;
    min-width: 0;
  }

  /* --- Location & Icon (Grey/Muted) --- */
  .meta-line {
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.875rem;
    flex-wrap: wrap;
  }

  .meta-line i {
    color: var(--muted); /* Education-style grey icon */
    font-size: 0.8rem;
  }

  /* --- Company Tag (Substitute for Org Badge) --- */
  .org-badge {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    background: var(--bg-elev);
    border: 1px solid var(--border);
    color: var(--text);
    font-weight: 600;
    font-size: 0.825rem;
    letter-spacing: 0.01em;
    transition: border-color 0.2s ease;
  }

  .experience-card:hover .org-badge {
    border-color: var(--text);
  }

  /* --- Right Side Meta (Date) --- */
  .meta-right {
    color: var(--muted);
    text-align: right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  .meta-date {
    font-size: 0.825rem;
    color: var(--muted);
  }

  /* --- Description List (Bullets) --- */
  .card-list {
    margin: 1rem 0 1rem 1.5rem; /* Matched Education spacing */
    padding: 0;
    list-style-type: disc !important;
  }

  .card-list li {
    display: list-item !important;
    margin-bottom: 0.5rem;
    line-height: 1.55;
    color: var(--text);
    font-size: 0.925rem;
    text-align: justify;
    hyphens: auto;
  }

  /* Bullet Color Logic */
  .card-list li::marker {
    color: black;
  }
  :global([data-theme="dark"]) .card-list li::marker {
    color: white;
  }

  /* --- Skills --- */
  .kw-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: auto;
    padding-top: 0.5rem;
  }

  /* --- Responsive (Mobile) --- */
  @media (max-width: 768px) {
    .card-head {
      flex-direction: column;
      gap: 0.6rem;
    }
    .meta-right {
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      text-align: left;
    }
    .meta-left {
      align-items: flex-start;
    }
    .card-list {
      margin-left: 1.2rem;
    }
  }
</style>

<script>
  // Experience toggle functionality
  function initExperienceToggle() {
    const toggleBtn = document.getElementById(
      "experience-toggle",
    ) as HTMLButtonElement;
    const extraSection = document.getElementById("experience-extra");

    if (!toggleBtn || !extraSection) {
      return;
    }

    // Get text values from data attributes
    const moreText = toggleBtn.getAttribute("data-more-text") || "Show More";
    const lessText = toggleBtn.getAttribute("data-less-text") || "Show Less";
    const textSpan = toggleBtn.querySelector(".toggle-text");

    // Set initial state
    let isExpanded = false;

    // Handle click
    toggleBtn.addEventListener("click", function () {
      isExpanded = !isExpanded;

      if (isExpanded) {
        // Expand
        extraSection.setAttribute("data-collapsed", "false");
        toggleBtn.classList.add("expanded");
        if (textSpan) {
          textSpan.textContent = lessText;
        }
      } else {
        // Collapse
        extraSection.setAttribute("data-collapsed", "true");
        toggleBtn.classList.remove("expanded");
        if (textSpan) {
          textSpan.textContent = moreText;
        }

        // Scroll back to experience section
        const experienceSection = document.getElementById("experience");
        if (experienceSection) {
          setTimeout(() => {
            experienceSection.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });
          }, 100);
        }
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initExperienceToggle);
  } else {
    initExperienceToggle();
  }

  // Also initialize on Astro page transitions (View Transitions API)
  document.addEventListener("astro:page-load", initExperienceToggle);
</script>
