---
// src/components/sections/Projects.astro
// Projects section component with carousel functionality for showcasing portfolio projects

import Section from "../common/Section.astro";
import Badge from "../common/Badge.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

export interface Props {
  /** Custom projects data (overrides fetched collection) */
  projects?: CollectionEntry<"projects">[];
  /** Whether to show the carousel navigation */
  showNavigation?: boolean;
  /** Additional CSS classes */
  class?: string;
}

// Fetch projects from content collection if not provided
const fetchedProjects = await getCollection("projects");

// Sort projects by slug (filename) to respect numerical order
const sortedProjects = fetchedProjects.sort((a, b) => 
  a.slug.localeCompare(b.slug, undefined, { numeric: true })
);

const {
  projects = sortedProjects,
  showNavigation = true,
  class: className = "",
} = Astro.props;
---

<Section id="projects" title="Projects" class={className}>
  <div class="proj-carousel">
    <div class="proj-viewport">
      <div class="proj-track" id="proj-track">
        {projects.map((project) => {
          const isPublic = project.data.visibility === "public";
          return (
            <a
              href={`/projects/${project.slug}`}
              class="tile project-card"
              data-oss={isPublic ? "true" : undefined}
            >
              <div class="tile-body">
                <h3>{project.data.title}</h3>
                <p class="muted">{project.data.description}</p>
                <div class="kw-list">
                  <Badge
                    variant={isPublic ? "public" : "private"}
                    size="sm"
                    hoverable={false}
                  >
                    {isPublic ? "Public" : "Private"}
                  </Badge>
                  {project.data.tags.slice(0, 6).map((tag) => (
                    <Badge variant="default" size="sm" hoverable={false}>
                      {tag}
                    </Badge>
                  ))}
                  {project.data.tags.length > 6 && (
                    <Badge variant="muted" size="sm" hoverable={false}>
                      +{project.data.tags.length - 6}
                    </Badge>
                  )}
                </div>
              </div>
              <div class="tile-foot">
                <div class="project-stats">
                  {project.data.githubStars !== undefined && (
                    <span class="stat-item" title={`${project.data.githubStars} GitHub stars`}>
                      <i class="fa-solid fa-star"></i>
                      {project.data.githubStars >= 1000 
                        ? `${(project.data.githubStars / 1000).toFixed(1)}k` 
                        : project.data.githubStars}
                    </span>
                  )}
                  {project.data.downloads !== undefined && (
                    <span class="stat-item" title={`${project.data.downloads} downloads`}>
                      <i class="fa-solid fa-download"></i>
                      {project.data.downloads >= 1000 
                        ? `${(project.data.downloads / 1000).toFixed(1)}k` 
                        : project.data.downloads}
                    </span>
                  )}
                </div>
                <span class="link">Read more â†’</span>
              </div>
            </a>
          );
        })}
      </div>
    </div>

    {showNavigation && projects.length > 1 && (
      <nav class="proj-nav" aria-label="Project carousel navigation">
        <div class="proj-indicators" id="proj-indicators">
          <!-- Arrows and indicators will be generated by JavaScript -->
        </div>
      </nav>
    )}
  </div>
</Section>

<style>
  /* Carousel container */
  .proj-carousel {
    position: relative;
    width: 100%;
  }

  /* Viewport clips the overflow */
  .proj-viewport {
    overflow: hidden;
    width: 100%;
    padding: 0.5rem 0;
  }

  /* Track holds all cards and slides */
  .proj-track {
    display: flex;
    gap: 24px;
    transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
    will-change: transform;
  }

  /* Project card styling */
  .project-card {
    flex: 0 0 calc((100% - 48px) / 3);
    min-width: 280px;
    max-width: 400px;
    border: 1px solid var(--border);
    background: var(--card);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
    text-decoration: none;
    color: inherit;
    transition:
      transform 0.25s ease,
      box-shadow 0.25s ease,
      border-color 0.25s ease;
  }

  .project-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 14px 36px rgba(0, 0, 0, 0.33);
    border-color: var(--text);
  }

  .project-card:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Card content */
  .tile-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .tile-body h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
    line-height: 1.3;
  }

  .tile-body .muted {
    font-size: 0.9rem;
    line-height: 1.5;
    color: var(--muted);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Keywords/tags list */
  .kw-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin-top: auto;
    padding-top: 0.5rem;
  }

  /* Card footer */
  .tile-foot {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border);
    margin-top: auto;
  }

  .tile-foot .link {
    color: var(--accent);
    font-size: 0.9rem;
    font-weight: 500;
    transition: color 0.2s ease;
  }

  .project-card:hover .tile-foot .link {
    color: var(--muted);
  }

  /* Project stats in footer */
  .project-stats {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .stat-item {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.2rem 0.5rem;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 0.8rem;
    font-weight: 500;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .stat-item i {
    font-size: 0.75rem;
    color: var(--muted);
    transition: color 0.2s ease;
  }

  /* Star icon color */
  .stat-item:first-child i {
    color: #fbbf24;
  }

  /* Download icon color */
  .stat-item:last-child i {
    color: #3b82f6;
  }

  /* Stats remain unchanged on card hover */

  /* Navigation container */
  .proj-nav {
    display: flex;
    justify-content: center;
    margin-top: 1.5rem;
  }

  .proj-indicators {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Arrow buttons (generated by JS) */
  :global(.proj-arrow) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: var(--bg-elev);
    border: 1px solid var(--border);
    color: var(--text);
    cursor: pointer;
    transition:
      background-color 0.2s ease,
      border-color 0.2s ease,
      color 0.2s ease,
      opacity 0.2s ease;
  }

  :global(.proj-arrow:hover) {
    border-color: var(--text);
    background: var(--bg);
  }

  :global(.proj-arrow:disabled) {
    opacity: 0.4;
    cursor: not-allowed;
  }

  :global(.proj-arrow:focus-visible) {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Indicator buttons (generated by JS) */
  :global(.proj-indicator) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 32px;
    padding: 0 0.5rem;
    background: var(--bg-elev);
    border: 1px solid var(--border);
    color: var(--muted);
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition:
      background-color 0.2s ease,
      border-color 0.2s ease,
      color 0.2s ease;
  }

  :global(.proj-indicator:hover) {
    border-color: var(--text);
    color: var(--text);
  }

  :global(.proj-indicator.active) {
    background: var(--text);
    border-color: var(--text);
    color: var(--bg);
  }

  :global(.proj-indicator:focus-visible) {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Light theme adjustments */
  :global([data-theme="light"]) .project-card {
    background: var(--card);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  :global([data-theme="light"]) .project-card:hover {
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
    border-color: var(--text);
  }

  :global([data-theme="light"]) :global(.proj-arrow) {
    background: var(--bg-elev);
    border-color: var(--border);
  }

  :global([data-theme="light"]) :global(.proj-indicator) {
    background: var(--bg-elev);
  }

  :global([data-theme="light"]) :global(.proj-indicator.active) {
    background: var(--text);
    color: var(--bg);
  }

  :global([data-theme="light"]) .stat-item {
    background: transparent;
    border-color: var(--border);
  }

  /* Responsive - Tablet */
  @media (max-width: 1024px) {
    .project-card {
      flex: 0 0 calc((100% - 24px) / 2);
    }
  }

  /* Responsive - Mobile */
  @media (max-width: 768px) {
    .proj-viewport {
      overflow-x: auto;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      scroll-snap-type: x mandatory;
    }

    .proj-viewport::-webkit-scrollbar {
      display: none;
    }

    .proj-track {
      gap: 1rem;
      padding: 0 0.5rem;
    }

    .project-card {
      flex: 0 0 85%;
      max-width: none;
      scroll-snap-align: start;
    }

    .proj-nav {
      display: none; /* Hide navigation on mobile, use swipe instead */
    }
  }

  @media (max-width: 480px) {
    .project-card {
      flex: 0 0 90%;
      padding: 0.9rem;
    }

    .tile-body h3 {
      font-size: 1rem;
    }

    .tile-body .muted {
      font-size: 0.85rem;
      -webkit-line-clamp: 2;
    }

    .stat-item {
      padding: 0.15rem 0.4rem;
      font-size: 0.75rem;
    }

    .stat-item i {
      font-size: 0.7rem;
    }

    .tile-foot .link {
      font-size: 0.85rem;
    }

    .kw-list {
      gap: 0.3rem;
    }
  }

  /* Touch device optimizations */
  @media (hover: none) and (pointer: coarse) {
    .project-card:hover {
      transform: none;
      box-shadow: none;
    }

    .project-card:active {
      transform: scale(0.99);
    }
  }

  /* Desktop - restore JS-controlled carousel */
  @media (min-width: 769px) {
    .proj-viewport {
      overflow: hidden;
    }

    .proj-track {
      transform: translateX(0);
    }
  }
</style>

<script>
  // Project carousel functionality with arrows and numbered indicators
  function initCarousel() {
    let currentProjectIndex = 0;
    const track = document.getElementById("proj-track");
    const indicatorsContainer = document.getElementById("proj-indicators");

    if (!track) return;

    const cards = track.querySelectorAll(".project-card");
    const totalCards = cards.length;

    if (totalCards === 0) return;

    // Calculate how many cards to show at once based on screen size
    function getCardsToShow(): number {
      if (window.innerWidth < 768) return 1;
      if (window.innerWidth < 1024) return 2;
      return 3;
    }

    // Generate numbered indicators with arrows
    function generateIndicators(): void {
      if (!indicatorsContainer || totalCards === 0) return;

      const cardsToShow = getCardsToShow();
      let totalIndicators: number;

      if (totalCards <= cardsToShow) {
        totalIndicators = 1;
      } else {
        totalIndicators = totalCards - cardsToShow + 1;
      }

      indicatorsContainer.innerHTML = "";

      // Add previous arrow
      const prevArrow = document.createElement("button");
      prevArrow.className = "proj-arrow prev";
      prevArrow.id = "proj-prev";
      prevArrow.setAttribute("aria-label", "Previous project");
      prevArrow.innerHTML = '<i class="fa-solid fa-chevron-left"></i>';

      prevArrow.addEventListener("click", () => {
        currentProjectIndex = Math.max(0, currentProjectIndex - 1);
        updateCarousel();
      });

      indicatorsContainer.appendChild(prevArrow);

      // Add indicator buttons
      for (let i = 0; i < totalIndicators; i++) {
        const indicator = document.createElement("button");
        indicator.className = "proj-indicator";
        indicator.setAttribute("data-index", String(i));
        indicator.setAttribute("aria-label", `Go to project position ${i + 1}`);
        indicator.textContent = String(i + 1);

        if (i === currentProjectIndex) {
          indicator.classList.add("active");
        }

        indicator.addEventListener("click", () => {
          currentProjectIndex = i;
          updateCarousel();
        });

        indicatorsContainer.appendChild(indicator);
      }

      // Add next arrow
      const nextArrow = document.createElement("button");
      nextArrow.className = "proj-arrow next";
      nextArrow.id = "proj-next";
      nextArrow.setAttribute("aria-label", "Next project");
      nextArrow.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';

      nextArrow.addEventListener("click", () => {
        const cardsToShow = getCardsToShow();
        const maxIndex = totalCards <= cardsToShow ? 0 : totalCards - cardsToShow;
        currentProjectIndex = Math.min(maxIndex, currentProjectIndex + 1);
        updateCarousel();
      });

      indicatorsContainer.appendChild(nextArrow);
    }

    function updateCarousel(): void {
      const cardsToShow = getCardsToShow();
      const maxIndex = totalCards <= cardsToShow ? 0 : totalCards - cardsToShow;

      // Clamp index
      currentProjectIndex = Math.min(Math.max(0, currentProjectIndex), maxIndex);

      // Calculate offset
      const firstCard = cards[0] as HTMLElement;
      const cardWidth = firstCard?.offsetWidth || 0;
      const gap = 24; // matches CSS gap
      const offset = currentProjectIndex * (cardWidth + gap);

      track.style.transform = `translateX(-${offset}px)`;

      // Update button states
      const prevBtn = document.getElementById("proj-prev") as HTMLButtonElement;
      const nextBtn = document.getElementById("proj-next") as HTMLButtonElement;

      if (prevBtn) prevBtn.disabled = currentProjectIndex === 0;
      if (nextBtn) nextBtn.disabled = currentProjectIndex >= maxIndex;

      // Update indicators
      updateIndicators();
    }

    function updateIndicators(): void {
      const indicators = indicatorsContainer?.querySelectorAll(".proj-indicator");
      if (!indicators) return;

      indicators.forEach((indicator, index) => {
        if (index === currentProjectIndex) {
          indicator.classList.add("active");
        } else {
          indicator.classList.remove("active");
        }
      });
    }

    // Add keyboard navigation support
    document.addEventListener("keydown", (e) => {
      // Only handle if carousel is visible and in viewport
      const rect = track.getBoundingClientRect();
      const isVisible = rect.top < window.innerHeight && rect.bottom > 0;

      if (!isVisible) return;

      if (e.key === "ArrowLeft") {
        currentProjectIndex = Math.max(0, currentProjectIndex - 1);
        updateCarousel();
      } else if (e.key === "ArrowRight") {
        const cardsToShow = getCardsToShow();
        const maxIndex = totalCards <= cardsToShow ? 0 : totalCards - cardsToShow;
        currentProjectIndex = Math.min(maxIndex, currentProjectIndex + 1);
        updateCarousel();
      }
    });

    // Initialize
    generateIndicators();
    updateCarousel();

    // Update on window resize (debounced)
    let resizeTimeout: ReturnType<typeof setTimeout>;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        generateIndicators();
        updateCarousel();
      }, 150);
    });
  }

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", initCarousel);

  // Also initialize on Astro page transitions
  document.addEventListener("astro:page-load", initCarousel);
</script>
